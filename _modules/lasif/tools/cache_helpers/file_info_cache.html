

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lasif.tools.cache_helpers.file_info_cache &mdash; LASIF 0.1.x documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="LASIF 0.1.x documentation" href="../../../../index.html"/>
        <link rel="up" title="lasif" href="../../../lasif.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> LASIF
          

          
          </a>

          
            
            
              <div class="version">
                0.1.x
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../prerequisites.html">Installation, Testing &amp; DevInfo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../webinterface.html">Web Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_doc.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">LASIF</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../lasif.html">lasif</a> &raquo;</li>
        
      <li>lasif.tools.cache_helpers.file_info_cache</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lasif.tools.cache_helpers.file_info_cache</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A file info cache class. Must be subclassed.</span>

<span class="sd">The cache is able to monitor a bunch of (arbitrary) files and store some</span>
<span class="sd">indexes information about each file. This is useful for keeping track of a</span>
<span class="sd">large number of files and what is in them.</span>

<span class="sd">To subclass it you need to provide the values you want to index, the types of</span>
<span class="sd">files you want to index and functions to extract the indices and find the</span>
<span class="sd">files. Upon each call to the constructor it will check the existing database,</span>
<span class="sd">automatically remove any deleted files, reindex modified ones and add new ones.</span>

<span class="sd">This is much faster then reading the files every time but still provides a lot</span>
<span class="sd">of flexibility as the data can be managed by some other means.</span>


<span class="sd">Example implementation:</span>


<span class="sd">.. code-block:: python</span>

<span class="sd">    class ImageCache(object):</span>
<span class="sd">        def __init__(self, image_folder, cache_db_file):</span>
<span class="sd">            # The index values are a list of tuples. The first denotes the</span>
<span class="sd">            # name of the index and the second the type of the index. The types</span>
<span class="sd">            # have to correspond to SQLite types.</span>
<span class="sd">            self.index_values = [</span>
<span class="sd">                (&quot;width&quot;, &quot;INTEGER&quot;),</span>
<span class="sd">                (&quot;height&quot;, &quot;INTEGER&quot;),</span>
<span class="sd">                (&quot;type&quot;, &quot;TEXT&quot;)]</span>
<span class="sd">            # The types of files to index.</span>
<span class="sd">            self.filetypes = [&quot;png&quot;, &quot;jpeg&quot;]</span>

<span class="sd">            # Subclass specific values</span>
<span class="sd">            self.image_folder = image_folder</span>

<span class="sd">            # Don&#39;t forget to call the parents __init__()!</span>
<span class="sd">            super(ImageCache, self).__init__(cache_db_file=cache_db_file)</span>

<span class="sd">        # Now you need to define one &#39;find files&#39; and one &#39;index file&#39;</span>
<span class="sd">        # methods for each filetype. The &#39;find files&#39; method needs to be named</span>
<span class="sd">        # &#39;_find_files_FILETYPE&#39; and takes no arguments. The &#39;index file&#39;</span>
<span class="sd">        # method has to be named &#39;_extract_index_values_FILETYPE&#39; and takes one</span>
<span class="sd">        # argument: the path to file. It needs to return a list of lists. Each</span>
<span class="sd">        # inner list contains the indexed values in the same order as specified</span>
<span class="sd">        # in self.index_values. It can return multiple sets of indices per</span>
<span class="sd">        # file. Useful for lots of filetypes, not necessarily images as in the</span>
<span class="sd">        # example here.</span>

<span class="sd">        def _find_files_png(self):</span>
<span class="sd">            return glob.glob(os.path.join(&quot;*.png&quot;))</span>

<span class="sd">        def _find_files_jpeg(self):</span>
<span class="sd">            return glob.glob(os.path.join(&quot;*.png&quot;))</span>

<span class="sd">        def _extract_index_values_png(self, filename):</span>
<span class="sd">            # Do somethings to get the values.</span>
<span class="sd">            return [[400, 300, &quot;png&quot;]]</span>

<span class="sd">        def _extract_index_values_jpeg(self, filename):</span>
<span class="sd">            # Do somethings to get the values.</span>
<span class="sd">            return [[400, 300, &quot;jpeg&quot;]]</span>


<span class="sd">:copyright:</span>
<span class="sd">    Lion Krischer (krischer@geophysik.uni-muenchen.de), 2013</span>
<span class="sd">:license:</span>
<span class="sd">    GNU General Public License, Version 3</span>
<span class="sd">    (http://www.gnu.org/copyleft/gpl.html)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">binascii</span> <span class="k">import</span> <span class="n">crc32</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">izip</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">progressbar</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">lasif</span> <span class="k">import</span> <span class="n">LASIFWarning</span>


<span class="c1"># Table definition of the &#39;files&#39; table. Used for creating and validating</span>
<span class="c1"># the table.</span>
<span class="n">FILES_TABLE_DEFINITION</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;INTEGER&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;TEXT&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;filesize&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;INTEGER&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;last_modified&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;REAL&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="sa">u</span><span class="s2">&quot;crc32_hash&quot;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;INTEGER&quot;</span><span class="p">)</span>
<span class="p">)</span>


<div class="viewcode-block" id="FileInfoCache"><a class="viewcode-back" href="../../../../tools.file_info_cache.html#lasif.tools.cache_helpers.file_info_cache.FileInfoCache">[docs]</a><span class="k">class</span> <span class="nc">FileInfoCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object able to cache information about arbitrary files on the filesystem.</span>

<span class="sd">    Intended to be subclassed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_db_file</span><span class="p">,</span> <span class="n">root_folder</span><span class="p">,</span>
                 <span class="n">read_only</span><span class="p">,</span> <span class="n">pretty_name</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span> <span class="o">=</span> <span class="n">cache_db_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span> <span class="o">=</span> <span class="n">root_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="n">read_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span> <span class="o">=</span> <span class="n">pretty_name</span>

        <span class="c1"># Will be filled in _init_database() method.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Will be filled once database has been updated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Readonly mode disable updates and the creation of new databases.</span>
        <span class="c1"># This is useful for scenarios where multiple processes access the</span>
        <span class="c1"># same file cache database concurrently which otherwise can result</span>
        <span class="c1"># in locked databases. Of course the cache database must already be</span>
        <span class="c1"># built for that to work.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cache DB &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exists and cannot &quot;</span>
                                 <span class="s2">&quot;be created as it has been requested in &quot;</span>
                                 <span class="s2">&quot;read-only mode.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
            <span class="c1"># Open in read-only mode (seen in</span>
            <span class="c1"># http://stackoverflow.com/a/28302809/1657047)</span>
            <span class="c1"># I am not sure this actually works as it opens the file in</span>
            <span class="c1"># read-only mode but not necessarily the database. It will work</span>
            <span class="c1"># if SQLite3 notices the file pointer is in read-only mode and</span>
            <span class="c1"># adjusts accordingly which might very well be the case.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;/dev/fd/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_database</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cache DB &#39;</span><span class="si">%s</span><span class="s2">&#39; did not validate and cannot be created &quot;</span>
                    <span class="s2">&quot;anew as it has been requested in read-only mode.&quot;</span> <span class="o">%</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_database</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_indices</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_fd&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fd</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">file_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns number of files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QUERY</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) FROM files;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">QUERY</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns number of indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QUERY</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) FROM indices;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">QUERY</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total file size in bytes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QUERY</span> <span class="o">=</span> <span class="s2">&quot;SELECT SUM(filesize) FROM files;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">QUERY</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_validate_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the tables and database scheme.</span>

<span class="sd">        Useful for migrations in which the database is simply deleted and</span>
<span class="sd">        build anew.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT name FROM sqlite_master WHERE type = &#39;table&#39;;&quot;</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sorted</span><span class="p">([</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite_sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;indices&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check the indices table.</span>
        <span class="n">i_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA table_info(indices);&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">i_t</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">_i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">i_t</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i_t</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check the files table.</span>
        <span class="n">f_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA table_info(files);&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">f_t</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">_i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">f_t</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">f_t</span> <span class="o">!=</span> <span class="n">FILES_TABLE_DEFINITION</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_init_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inits the database connects, turns on foreign key support and creates</span>
<span class="sd">        the tables if they do not already exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure the folder of the database file exists and otherwise</span>
        <span class="c1"># raise a descriptive error message.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The folder &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist. Cannot create database in &quot;</span>
                <span class="s2">&quot;it.&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">))</span>
        <span class="c1"># Check if the file exists. If it exists, try to use it, otherwise</span>
        <span class="c1"># delete and create a new one. This should take care that a new</span>
        <span class="c1"># database is created in the case of DB corruption due to a power</span>
        <span class="c1"># failure.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                <span class="c1"># Make sure the database is still valid. This automatically</span>
                <span class="c1"># enables migrations to newer database schema definition in</span>
                <span class="c1"># newer LASIF versions.</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_database</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">valid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cache &#39;</span><span class="si">%s</span><span class="s2">&#39; is not valid anymore. This is most &quot;</span>
                          <span class="s2">&quot;likely due to some recent LASIF update. Don&#39;t &quot;</span>
                          <span class="s2">&quot;worry, LASIF will built it anew. Hang on...&quot;</span> <span class="o">%</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_db_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Enable foreign key support.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON;&quot;</span><span class="p">)</span>

        <span class="c1"># Turn off synchronous writing. Much much faster inserts at the price</span>
        <span class="c1"># of risking corruption at power failure. Worth the risk as the</span>
        <span class="c1"># databases are just created from the data and can be recreated at any</span>
        <span class="c1"># time.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA synchronous = OFF;&quot;</span><span class="p">)</span>

        <span class="c1"># This greatly speeds up deleting files. Data corruptions is again</span>
        <span class="c1"># not a really big issue.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA SECURE_DELETE = OFF;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># Make sure that foreign key support has been turned on.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Could not enable foreign key support for SQLite. Please &quot;</span>
                   <span class="s2">&quot;contact the LASIF developers.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Create the tables.</span>
        <span class="n">sql_create_files_table</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS files (</span>
<span class="s2">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">                </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">            );</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span>
                       <span class="n">FILES_TABLE_DEFINITION</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_create_files_table</span><span class="p">)</span>

        <span class="n">sql_create_index_table</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS indices (</span>
<span class="s2">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">                </span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                filepath_id INTEGER,</span>
<span class="s2">                FOREIGN KEY(filepath_id) REFERENCES files(id) ON DELETE CASCADE</span>
<span class="s2">            );</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_i</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_values</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_create_index_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;indices&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">get_indices_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT name FROM sqlite_master</span>
<span class="s2">            WHERE type=&#39;index&#39;;&quot;&quot;&quot;</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">get_indices_query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Drop all indices no.</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DROP INDEX </span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;CREATE INDEX </span><span class="si">%s</span><span class="s2"> on indices(</span><span class="si">%s</span><span class="s2">);&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_all_files_by_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all files for all filetypes by filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetypes</span><span class="p">:</span>
            <span class="n">get_file_fct</span> <span class="o">=</span> <span class="s2">&quot;_find_files_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filetype</span>
            <span class="c1"># Paths are relative to the root folder.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filetype</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">)</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_file_fct</span><span class="p">)()]</span>

    <span class="k">def</span> <span class="nf">_get_all_files_from_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all files that actually have indexes by querying the database.</span>

<span class="sd">        This assumes self._get_all_files_by_filename() has already been</span>
<span class="sd">        called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filenames</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT filename FROM files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">)</span>

        <span class="c1"># Filter to exclude all files not correctly indexed.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filenames</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

<div class="viewcode-block" id="FileInfoCache.update"><a class="viewcode-back" href="../../../../tools.file_info_cache.html#lasif.tools.cache_helpers.file_info_cache.FileInfoCache.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get all files first.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_files_by_filename</span><span class="p">()</span>

        <span class="c1"># Get all files currently in the database and reshape into a</span>
        <span class="c1"># dictionary. The dictionary key is the filename and the value a tuple</span>
        <span class="c1"># of (id, last_modified, crc32 hash).</span>
        <span class="n">db_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM files&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">db_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">_i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">db_files</span><span class="p">}</span>

        <span class="c1"># Count all files</span>
        <span class="n">filecount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetypes</span><span class="p">:</span>
            <span class="n">filecount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filetype</span><span class="p">])</span>

        <span class="c1"># XXX: Check which files have the correct mtime outside the loop.</span>
        <span class="c1"># Then the case when the caches already exist should be much faster</span>
        <span class="c1"># (and the average case as well...)</span>

        <span class="c1"># Use a progressbar if the filecount is large so something appears on</span>
        <span class="c1"># screen.</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">update_interval</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">current_file_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Store the old working directory and change to the root folder</span>
            <span class="c1"># to get relative pathnames.</span>
            <span class="n">org_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">)</span>

            <span class="c1"># Now update all filetypes separately.</span>
            <span class="k">for</span> <span class="n">filetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetypes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">filetype</span><span class="p">]:</span>
                    <span class="n">current_file_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># Only show the progressbar if more then 3.5 seconds have</span>
                    <span class="c1"># passed.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pbar</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="mf">3.5</span><span class="p">):</span>
                        <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s2">&quot;Updating </span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span><span class="p">,</span>
                            <span class="n">progressbar</span><span class="o">.</span><span class="n">Percentage</span><span class="p">(),</span>
                            <span class="n">progressbar</span><span class="o">.</span><span class="n">Bar</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ETA</span><span class="p">()]</span>
                        <span class="n">pbar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span>
                            <span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">filecount</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="n">update_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">filecount</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_file_count</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pbar</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">current_file_count</span> <span class="o">%</span> <span class="n">update_interval</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_file_count</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">db_files</span><span class="p">:</span>
                        <span class="c1"># Delete the file from the list of files to keep</span>
                        <span class="c1"># track of files no longer available.</span>
                        <span class="n">this_file</span> <span class="o">=</span> <span class="n">db_files</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">db_files</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
                        <span class="n">abs_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

                        <span class="n">last_modified</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">)</span>
                        <span class="c1"># If the last modified time is identical to a</span>
                        <span class="c1"># second, do nothing.</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">last_modified</span> <span class="o">-</span> <span class="n">this_file</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="c1"># Otherwise check the hash.</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">open_file</span><span class="p">:</span>
                            <span class="n">hash_value</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="n">open_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">hash_value</span> <span class="o">==</span> <span class="n">this_file</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="c1"># XXX: Update last modified times, otherwise it</span>
                            <span class="c1"># will hash again and again.</span>
                            <span class="k">continue</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_file</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span>
                                          <span class="n">this_file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_update_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                                          <span class="n">filetype</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">org_directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

        <span class="c1"># Remove all files no longer part of the cache DB.</span>
        <span class="k">if</span> <span class="n">db_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">%i</span><span class="s2"> no longer existing files from the &quot;</span>
                      <span class="s2">&quot;cache database. This might take a while ...&quot;</span> <span class="o">%</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">db_files</span><span class="p">))</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM files WHERE filename IN (</span><span class="si">%s</span><span class="s2">);&quot;</span> <span class="o">%</span> \
                <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">_i</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">db_files</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Update the self.files dictionary, this time from the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_files_from_database</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileInfoCache.get_values"><a class="viewcode-back" href="../../../../tools.file_info_cache.html#lasif.tools.cache_helpers.file_info_cache.FileInfoCache.get_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of dictionaries containing all indexed values for every</span>
<span class="sd">        file together with the filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">org_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">)</span>

            <span class="c1"># Assemble the query. Use a simple join statement.</span>
            <span class="n">sql_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">%s</span><span class="s2">, files.filename</span>
<span class="s2">            FROM indices</span>
<span class="s2">            INNER JOIN files</span>
<span class="s2">            ON indices.filepath_id=files.id</span>
<span class="s2">            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;indices.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_values</span><span class="p">])</span>

            <span class="n">all_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_values</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">_i</span><span class="p">)}</span>
                <span class="n">values</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">_i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">all_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">org_directory</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_values</span></div>

<div class="viewcode-block" id="FileInfoCache.get_details"><a class="viewcode-back" href="../../../../tools.file_info_cache.html#lasif.tools.cache_helpers.file_info_cache.FileInfoCache.get_details">[docs]</a>    <span class="k">def</span> <span class="nf">get_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the indexed information about one file.</span>

<span class="sd">        :param filename: The filename for which to request information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">)</span>

        <span class="c1"># Assemble the query. Use a simple join statement.</span>
        <span class="n">sql_query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT </span><span class="si">%s</span><span class="s2">, files.filename</span>
<span class="s2">        FROM indices</span>
<span class="s2">        INNER JOIN files</span>
<span class="s2">        ON indices.filepath_id=files.id</span>
<span class="s2">        WHERE files.filename=&#39;</span><span class="si">%s</span><span class="s2">&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;indices.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_values</span><span class="p">]),</span>
               <span class="n">filename</span><span class="p">)</span>

        <span class="n">all_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_values</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">_i</span><span class="p">)}</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">,</span> <span class="n">_i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">all_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_values</span></div>

    <span class="k">def</span> <span class="nf">_update_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span> <span class="n">filepath_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates or creates a new entry for the given file. If id is given, it</span>
<span class="sd">        will be interpreted as an update, otherwise as a fresh record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abs_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">rel_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_folder</span><span class="p">)</span>
        <span class="c1"># Remove all old indices for the file if it is an update.</span>
        <span class="k">if</span> <span class="n">filepath_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM indices WHERE &quot;</span>
                                   <span class="s2">&quot;filepath_id = </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filepath_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Get all indices from the file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_extract_index_values_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                    <span class="n">filetype</span><span class="p">)(</span><span class="n">abs_filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to index &#39;</span><span class="si">%s</span><span class="s2">&#39; of type &#39;</span><span class="si">%s</span><span class="s2">&#39; due to: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">abs_filename</span><span class="p">,</span> <span class="n">filetype</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">LASIFWarning</span><span class="p">)</span>

            <span class="c1"># If it is an update, also remove the file from the file list.</span>
            <span class="k">if</span> <span class="n">filepath_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;DELETE FROM files WHERE filename=&#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">rel_filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Could not extract any index from file &#39;</span><span class="si">%s</span><span class="s2">&#39; of type &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
                   <span class="s2">&quot;The file will be skipped.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">abs_filename</span><span class="p">,</span> <span class="n">filetype</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">LASIFWarning</span><span class="p">)</span>

            <span class="c1"># If it is an update, also remove the file from the file list.</span>
            <span class="k">if</span> <span class="n">filepath_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="s2">&quot;DELETE FROM files WHERE filename=&#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">rel_filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">return</span>

        <span class="c1"># Get the hash</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">open_file</span><span class="p">:</span>
            <span class="n">filehash</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="n">open_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="c1"># Add or update the file.</span>
        <span class="k">if</span> <span class="n">filepath_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;UPDATE files SET last_modified=</span><span class="si">%f</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;filesize=</span><span class="si">%i</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;crc32_hash=</span><span class="si">%i</span><span class="s2"> WHERE id=</span><span class="si">%i</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">),</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">),</span>
                                                <span class="n">filehash</span><span class="p">,</span> <span class="n">filepath_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;INSERT into files(filename, last_modified, filesize, &quot;</span>
                <span class="s2">&quot; crc32_hash) VALUES&quot;</span>
                <span class="s2">&quot;(&#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%i</span><span class="s2">, </span><span class="si">%i</span><span class="s2">);&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">rel_filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">abs_filename</span><span class="p">),</span> <span class="n">filehash</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">filepath_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_cursor</span><span class="o">.</span><span class="n">lastrowid</span>

        <span class="c1"># Append the file&#39;s path id to every index.</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath_id</span><span class="p">)</span>

        <span class="n">sql_insert_string</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO indices(</span><span class="si">%s</span><span class="s2">, filepath_id) VALUES(</span><span class="si">%s</span><span class="s2">);&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">sql_insert_string</span> <span class="o">%</span> <span class="p">(</span>
            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_values</span><span class="p">]),</span>
            <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;?&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])))),</span>
            <span class="n">indices</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Lion Krischer &amp; Andreas Fichtner.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'0.1.x',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>